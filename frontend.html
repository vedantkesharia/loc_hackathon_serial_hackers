<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speech Recognition with AI Response</title>
  </head>
  <body>
    <div id="output"></div>
    <div id="action"></div>
    <button onclick="startRecognition()">Start Voice Input</button>

    <script>
      var recognition;

      function startRecognition() {
        recognition = new webkitSpeechRecognition();
        recognition.lang = "en-US";
        recognition.continuous = false; // Prevent continuous recognition
        recognition.interimResults = false; // Turn off interim results
        recognition.onresult = function (event) {
          var transcript = event.results[0][0].transcript.trim().toLowerCase();
          document.getElementById("output").innerHTML =
            "<b>Spoken Text:</b> " + transcript;

          if (transcript.includes("wikipedia")) {
            getSearchQuery();
          } else if (transcript.includes("ask")) {
            getQuestion();
          } else {
            sendVoiceToPython(transcript);
          }
        };
        recognition.start();
      }



      function getSearchQuery() {
        recognition.stop();
        var innerRecognition = new webkitSpeechRecognition();
        innerRecognition.lang = "en-US";
        innerRecognition.continuous = false;
        innerRecognition.interimResults = false;
        innerRecognition.onresult = function (event) {
          var searchQuery = event.results[0][0].transcript.trim();
          document.getElementById("output").innerHTML +=
            "<br><b>Search Query:</b> " + searchQuery;
          sendVoiceToPythonForWikipedia(searchQuery);
        };
        document.getElementById("output").innerHTML +=
          "<br><b>Say your search query for Wikipedia:</b>";
        innerRecognition.start();
      }

      function getQuestion() {
        recognition.stop();
        var innerRecognition = new webkitSpeechRecognition();
        innerRecognition.lang = "en-US";
        innerRecognition.continuous = false;
        innerRecognition.interimResults = false;
        innerRecognition.onresult = function (event) {
          var question = event.results[0][0].transcript.trim();
          console.log('Transcript for "ask" command:', question); // Log the transcript
          document.getElementById("output").innerHTML +=
            "<br><b>Question:</b> " + question;
          sendVoiceToPythonForGemini(question);
        };
        document.getElementById("output").innerHTML +=
          "<br><b>Ask your question:</b>";
        innerRecognition.start();
      }

      function sendVoiceToPython(transcript) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://localhost:5000/gemini");
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            document.getElementById("action").innerHTML =
              "<small>AI Response:</small> " + response.ai_response;
            speak(response.ai_response); // Speak the AI response
            startRecognition(); // Start recognition again after response
          }
        };
        var data = JSON.stringify({ gemini: transcript });
        xhr.send(data);
      }

      function sendVoiceToPythonForWikipedia(searchQuery) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://localhost:5000/wiki_summary");
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            document.getElementById("action").innerHTML =
              "<small>Wikipedia Summary:</small> " + response.summary;
            speak(response.summary); // Speak the Wikipedia summary
            startRecognition(); // Start recognition again after response
          }
        };
        var data = JSON.stringify({ search_query: searchQuery });
        xhr.send(data);
      }

      function sendVoiceToPythonForGemini(question) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://localhost:5000/gemini");
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            document.getElementById("action").innerHTML =
              "<small>Gemini Response:</small> " + response.ai_response;
            speak(response.ai_response); // Speak the Gemini response
            startRecognition(); // Start recognition again after response
          }
        };
        var data = JSON.stringify({ gemini: question });
        xhr.send(data);
      }

      function speak(text) {
        var utterance = new SpeechSynthesisUtterance(text);
        utterance.onend = function () {
          startRecognition(); // Start recognition again after speaking is finished
        };
        window.speechSynthesis.speak(utterance);
      }
    </script>
  </body>
</html>
